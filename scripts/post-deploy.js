#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// æª¢æŸ¥éƒ¨ç½²è¼¸å‡º
function checkDeploymentOutput() {
  const outputDir = path.join(__dirname, '..', '.output', 'public');
  
  console.log('ğŸ” Checking deployment output...');
  
  if (!fs.existsSync(outputDir)) {
    console.log('âŒ .output/public directory not found');
    return false;
  }
  
  const requiredFiles = [
    'index.html',
    'robots.txt'
  ];
  
  const missingFiles = [];
  
  requiredFiles.forEach(file => {
    const filePath = path.join(outputDir, file);
    if (fs.existsSync(filePath)) {
      console.log(`âœ… ${file} exists in output`);
    } else {
      console.log(`âŒ ${file} missing from output`);
      missingFiles.push(file);
    }
  });
  
  // æª¢æŸ¥ sitemap.xml æ˜¯å¦ç”Ÿæˆ
  const sitemapPath = path.join(outputDir, 'sitemap.xml');
  if (fs.existsSync(sitemapPath)) {
    console.log('âœ… sitemap.xml exists in output');
  } else {
    console.log('âš ï¸  sitemap.xml not found in output (may be generated at runtime)');
  }
  
  if (missingFiles.length > 0) {
    console.log(`âš ï¸  Missing files in output: ${missingFiles.join(', ')}`);
    return false;
  }
  
  return true;
}

// é©—è­‰ robots.txt ä¸­çš„åŸŸå
function validateRobotsDomain() {
  const robotsPath = path.join(__dirname, '..', '.output', 'public', 'robots.txt');
  
  if (!fs.existsSync(robotsPath)) {
    console.log('âŒ robots.txt not found in output');
    return false;
  }
  
  try {
    const content = fs.readFileSync(robotsPath, 'utf8');
    
    // æª¢æŸ¥æ˜¯å¦åŒ…å« GitHub Pages æ ¼å¼çš„ URL
    if (!content.includes('github.io')) {
      console.log('âš ï¸  robots.txt may not contain GitHub Pages URL format');
    }
    
    // æª¢æŸ¥ sitemap URL æ˜¯å¦æ­£ç¢º
    if (!content.includes('/sitemap.xml')) {
      console.log('âš ï¸  robots.txt sitemap URL may not be correct');
    }
    
    console.log('âœ… robots.txt domain validation passed');
    return true;
  } catch (error) {
    console.log(`âŒ Error reading robots.txt: ${error.message}`);
    return false;
  }
}

// æª¢æŸ¥ Nuxt é…ç½®
function validateNuxtConfig() {
  const configPath = path.join(__dirname, '..', 'nuxt.config.ts');
  
  if (!fs.existsSync(configPath)) {
    console.log('âŒ nuxt.config.ts not found');
    return false;
  }
  
  try {
    const content = fs.readFileSync(configPath, 'utf8');
    
    // æª¢æŸ¥æ˜¯å¦åŒ…å«æ­£ç¢ºçš„ site é…ç½®
    if (!content.includes('minsdreamknowledge.github.io')) {
      console.log('âš ï¸  nuxt.config.ts may not contain correct GitHub Pages URL');
    }
    
    // æª¢æŸ¥æ˜¯å¦åŒ…å« sitemap æ¨¡çµ„
    if (!content.includes('@nuxtjs/sitemap')) {
      console.log('âŒ @nuxtjs/sitemap module not found in nuxt.config.ts');
      return false;
    }
    
    // æª¢æŸ¥æ˜¯å¦åŒ…å« site é…ç½®
    if (!content.includes('site:')) {
      console.log('âŒ site configuration not found in nuxt.config.ts');
      return false;
    }
    
    console.log('âœ… nuxt.config.ts validation passed');
    return true;
  } catch (error) {
    console.log(`âŒ Error reading nuxt.config.ts: ${error.message}`);
    return false;
  }
}

// æª¢æŸ¥æ–‡ä»¶å¤§å°
function checkFileSizes() {
  const outputDir = path.join(__dirname, '..', '.output', 'public');
  
  console.log('ğŸ“Š Checking file sizes...');
  
  const files = [
    { name: 'index.html', maxSize: 100 * 1024 }, // 100KB
    { name: 'robots.txt', maxSize: 1 * 1024 }    // 1KB
  ];
  
  let allValid = true;
  
  files.forEach(file => {
    const filePath = path.join(outputDir, file.name);
    if (fs.existsSync(filePath)) {
      const stats = fs.statSync(filePath);
      const sizeKB = Math.round(stats.size / 1024);
      
      if (stats.size > file.maxSize) {
        console.log(`âš ï¸  ${file.name} is ${sizeKB}KB (max: ${file.maxSize / 1024}KB)`);
        allValid = false;
      } else {
        console.log(`âœ… ${file.name} size: ${sizeKB}KB`);
      }
    }
  });
  
  // æª¢æŸ¥ sitemap.xml å¤§å°
  const sitemapPath = path.join(outputDir, 'sitemap.xml');
  if (fs.existsSync(sitemapPath)) {
    const stats = fs.statSync(sitemapPath);
    const sizeKB = Math.round(stats.size / 1024);
    console.log(`âœ… sitemap.xml size: ${sizeKB}KB`);
  }
  
  return allValid;
}

// ä¸»å‡½æ•¸
function main() {
  console.log('ğŸš€ Post-deployment validation...\n');
  
  const checks = [
    checkDeploymentOutput(),
    validateRobotsDomain(),
    validateNuxtConfig(),
    checkFileSizes()
  ];
  
  const allPassed = checks.every(check => check);
  
  console.log('\nğŸ“Š Validation Summary:');
  if (allPassed) {
    console.log('âœ… All validations passed! Deployment successful.');
    console.log('ğŸ“ Note: Sitemap is generated by @nuxtjs/sitemap module at /sitemap.xml');
    process.exit(0);
  } else {
    console.log('âŒ Some validations failed. Please check deployment.');
    process.exit(1);
  }
}

// åŸ·è¡Œä¸»å‡½æ•¸
main(); 